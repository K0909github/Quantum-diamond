# ===============================================
# N implantation into undoped diamond (no pre-doping)
# Ref: NV&Nimplantation&predoping/in.nv_injection.lmp
# ===============================================

# ---------- 0. Parameters ----------
variable        a            equal 3.57            # diamond lattice constant (Angstrom)
variable        nx           equal 40              # box size in lattice units (x)
variable        ny           equal 40              # box size in lattice units (y)
variable        nz           equal 30              # box size in lattice units (z)

variable        dt           equal 0.001           # timestep [ps] (1 fs)
variable        seed         equal 12345

# ion implantation setup
variable        energy_eV    equal 1600.0          # N ion energy [eV]
variable        n_ions       equal 100             # number of ions to insert (approx, depends on attempts)

# schedule (steps)
variable        nrelax1      equal 10000           # 10 ps
variable        nimplant     equal 350000          # 350 ps
variable        nrelax2      equal 150000          # 150 ps
variable        nramp        equal 50000           # 50 ps (293K->1600K)
variable        nanneal      equal 7400000         # 7.4 ns @1600K
variable        ncool        equal 50000           # 50 ps (1600K->293K)
variable        nfinal       equal 100000          # 100 ps @293K

# ---------- 1. Initialization ----------
units           metal
dimension       3
boundary        p p f                 # X,Y periodic; Z fixed
atom_style      atomic

thermo          1000
thermo_style    custom step atoms temp pe ke etotal press

# ---------- 2. Create box and atoms (pure C substrate) ----------
lattice         diamond ${a}
region          box block 0 ${nx} 0 ${ny} 0 ${nz} units lattice
create_box      2 box                       # type 1=C, type 2=N
create_atoms    1 box                       # fill with carbon (type 1)

mass            1 12.011
mass            2 14.007

# layers for thermostatting (bottom) and Newton region (mobile)
region          thermostat_layer block INF INF INF INF 0 2 units lattice
variable        z_mobile_hi  equal ${nz}-2
region          newton_layer     block INF INF INF INF 2 ${z_mobile_hi} units lattice
group           thermostat_atoms region thermostat_layer
group           newton_atoms     region newton_layer
group           simulation_atoms union newton_atoms thermostat_atoms

# region at the top surface for ion insertion (thin slab near zmax)
variable        zmax        equal ${nz}
variable        inj_lo      equal ${zmax}-0.5
variable        inj_hi      equal ${zmax}-0.1
region          inject      block INF INF INF INF ${inj_lo} ${inj_hi} units lattice

# ---------- 3. Potential ----------
pair_style      tersoff/zbl
pair_coeff      * * BNC_tersoff_zbl.potential C N
neighbor        2.0 bin
neigh_modify    delay 10 check yes

# ---------- 4. Initial relaxation @293K ----------
timestep        ${dt}
velocity        simulation_atoms create 293.0 54321 mom yes rot yes
fix             fNVT simulation_atoms nvt temp 293.0 293.0 0.1
fix             fLAN thermostat_atoms langevin 293.0 293.0 0.1 98765
run             ${nrelax1}
unfix           fNVT
unfix           fLAN

# dumps
dump            dtraj all custom 10000 trajectory.dump id type x y z
dump_modify     dtraj sort id

# ---------- 5. Ion implantation (N type=2, downward velocity) ----------
# Convert energy to velocity for Nitrogen
variable        energy_J     equal ${energy_eV}*1.60218e-19
variable        mass_kg      equal 14.007*1.66054e-27
variable        v_mps        equal sqrt(2*${energy_J}/${mass_kg})
variable        v_Aps        equal ${v_mps}/1.0e10

# deposit ions with fixed downward vz; attempts helps placement
# Modern syntax: N, type, seed, with keyword 'attempt'
fix             implant all deposit ${n_ions} 2 ${seed} region inject attempt 10 vz -${v_Aps} -${v_Aps}

run             ${nimplant}
unfix           implant

# post-implant relaxation @293K
fix             fNVT simulation_atoms nvt temp 293.0 293.0 0.1
fix             fLAN thermostat_atoms langevin 293.0 293.0 0.1 98765
run             ${nrelax2}
unfix           fNVT
unfix           fLAN

# ---------- 6. Annealing ----------
# ramp up 293K -> 1600K over 50 ps
fix             fNVT simulation_atoms nvt temp 293.0 1600.0 0.5
fix             fLAN thermostat_atoms langevin 293.0 1600.0 0.5 13579
run             ${nramp}
unfix           fNVT
unfix           fLAN

# hold at 1600K (7.4 ns)
fix             fNVT simulation_atoms nvt temp 1600.0 1600.0 0.1
fix             fLAN thermostat_atoms langevin 1600.0 1600.0 0.1 24680
run             ${nanneal}
unfix           fNVT
unfix           fLAN

# ---------- 7. Cooling and final relaxation ----------
# cool down 1600K -> 293K over 50 ps
fix             fNVT simulation_atoms nvt temp 1600.0 293.0 0.5
fix             fLAN thermostat_atoms langevin 1600.0 293.0 0.5 11223
run             ${ncool}
unfix           fNVT
unfix           fLAN

# final relax @293K
fix             fNVT simulation_atoms nvt temp 293.0 293.0 0.1
fix             fLAN thermostat_atoms langevin 293.0 293.0 0.1 33445
run             ${nfinal}
unfix           fNVT
unfix           fLAN

print           "Simulation finished."
