# LAMMPS input script for N2 cluster injection into diamond substrate
# GOAL: Create NV centers and measure their distances.
# FLOW: Create diamond -> Relax -> Inject N2 molecules -> Anneal -> Final output

# --- 1. 初期化 ---
units           metal
atom_style      charge
boundary        p p f  # x, y方向は周期的、z方向は真空層を設ける

# --- 2. シミュレーションボックスと原子の生成 ---
variable        a0 equal 3.567        # ダイヤモンドの格子定数 (Angstrom)
variable        nx equal 8            # x方向の繰り返し数
variable        ny equal 8            # y方向の繰り返し数
variable        nz equal 20           # z方向の繰り返し数 (真空層を含む, Lost atoms対策で厚く)

lattice         diamond ${a0}
region          box block 0 ${nx} 0 ${ny} 0 ${nz} units lattice
create_box      2 box                 # Type 1:C (炭素), Type 2:N (窒素)
create_atoms    1 box

mass            1 12.011              # 炭素の質量
mass            2 14.007              # 窒素の質量

# --- 3. Force Field (Potential) and Groups ---
# Define regions for thermostatting and fixing atoms
variable        z_mobile_hi equal ${nz}-4
variable        z_surface_lo equal ${nz}-4

region          r_bottom block INF INF INF INF 0 2 units lattice
region          r_mobile block INF INF INF INF 2 ${z_mobile_hi} units lattice
region          r_surface block INF INF INF INF ${z_surface_lo} ${nz} units lattice # Surface region for injection
group           g_bottom region r_bottom
group           g_mobile region r_mobile



# --- 全工程でBNC.tersoffを使用 ---
pair_style      tersoff
pair_coeff      * * BNC.tersoff C N

neighbor        0.3 bin
neigh_modify    delay 10
# fix qeq/reaxff は ReaxFF 専用なので削除します。

# --- 4. Initial Relaxation of the Substrate ---
thermo          100
thermo_style    custom step temp pe press



# --- minimize前に短いMD緩和を追加 ---
velocity        g_mobile create 10.0 12345 mom yes rot yes dist gaussian
fix             pre_relax g_mobile nvt temp 10.0 10.0 10.0
run             1000
unfix           pre_relax

# min_modifyコマンドで、原子が1ステップで動ける最大距離を制限する
min_modify      dmax 0.01
thermo          1                     # minimize直前は1ステップごとに出力

# エネルギー最小化を段階的に実行（sd:100/200, cg:200/2000）
min_style      sd
minimize       1.0e-4 1.0e-6 100 200
min_style      cg
minimize       1.0e-6 1.0e-8 200 2000


# --- ここでのポテンシャル切り替えは不要（BNC.tersoffを継続使用） ---

# timestep を小さくして計算を安定させる
timestep        0.1                   # 時間刻み 0.1 fs
reset_timestep  0

velocity        g_mobile create 300.0 54321 mom yes rot yes dist gaussian
fix             nvt_relax g_mobile nvt temp 300.0 300.0 $(100.0*dt)
velocity        g_bottom set 0.0 0.0 0.0 # 最下層を固定

run             5000                  # 500 fs 緩和計算を実行
unfix           nvt_relax

# --- 5. N2分子の注入ループ ---
timestep        0.1                   # 高エネルギー衝突のため時間刻みを小さくする

# 注入パラメータ
variable        n_events equal 10     # 注入するN2分子の数
variable        Einj_eV equal 200     # 窒素原子1つあたりの注入エネルギー (eV)

# 運動エネルギーから初速の大きさを計算
variable        m_N_amu equal 14.007
variable        eV2J equal 1.60218e-19
variable        amu2kg equal 1.66054e-27
variable        A_fs_2_m_s equal 1.0e5
variable        vmag_ms equal "sqrt(2 * v_Einj_eV * v_eV2J / v_m_N_amu / v_amu2kg)"
variable        vmag equal "v_vmag_ms / v_A_fs_2_m_s"

# 注入速度の設定 [cite: 2, 3, 4]
variable        vx equal 0.0 [cite: 4]
variable        vy equal 0.0 [cite: 4]
variable        vz equal -v_vmag [cite: 4]

# 表面のすぐ上に注入領域を定義
variable        z_insert equal "lz - 5.0"
region          rinj cylinder z $(lx/2) $(ly/2) $(lx/2-2) ${z_insert} ${z_insert}

# 注入中の温度制御を設定
fix             nvt1 g_mobile nvt temp 300.0 300.0 0.01 [cite: 4]
variable        nsteps_between equal 3000 [cite: 4]
dump            d1 all custom 1000 traj_inject.lammpstrj id type x y z [cite: 4, 6]

# ループを使って分子を注入し、その都度MD計算を実行
label           loopinj 
variable        i loop ${n_events} 
  create_atoms  2 random 1 987654 rinj mol n2.mol 12345 [cite: 1, 5]
  group         g_temp type 2 
  velocity      g_temp set v_vx v_vy v_vz sum yes 
  run           ${nsteps_between} 
  group         g_temp clear 
next            i 
jump            in.nv_injection.lmp loopinj 

unfix           nvt1 
undump          d1 

# --- 6. 注入後のアニーリング処理 ---
reset_timestep  0
timestep        1.0                   # アニーリング用に時間刻みを大きくする

# 1600 Kまで加熱
fix             nvt2 g_mobile nvt temp 300.0 1600.0 $(100.0*dt) 
thermo          500 
run             50000                 # 50 ps 加熱 
unfix           nvt2 

# 1600 Kで保持
fix             nvt3 g_mobile nvt temp 1600.0 1600.0 $(100.0*dt) 
run             50000                 # 50 ps 保持 
unfix           nvt3 

# 300 Kまで冷却
fix             nvt4 g_mobile nvt temp 1600.0 300.0 $(100.0*dt) 
run             50000                 # 50 ps 冷却 
unfix           nvt4 

# --- 7. 最終構造の出力 ---
dump            df all custom 1 final_snapshot.lammpstrj id type q x y z [cite: 6]
run             1 [cite: 6]
undump          df [cite: 6]

print "Simulation complete. Analyze with post_nv_distance.py" [cite: 6]