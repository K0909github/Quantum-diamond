############################################################
# Mini: N implantation into (undoped) diamond - short run  #
# Target: <~ 50k steps, small cell, few ions               #
############################################################

# ---------- 0. Parameters (small & fast) ----------
variable        a            equal 3.57
variable        nx           equal 12
variable        ny           equal 12
variable        nz           equal 12

variable        dt           equal 0.001        # 1 fs
variable        seed         equal 24680

variable        energy_eV    equal 1000.0       # lower to speed (1.0 keV)
variable        n_ions       equal 5            # only a few ions

# schedule (short)
variable        nrelax1      equal 2000         # 2 ps
variable        nimplant     equal 10000        # 10 ps
variable        nrelax2      equal 2000         # 2 ps
variable        nramp        equal 5000         # 5 ps
variable        nanneal      equal 10000        # 10 ps
variable        ncool        equal 5000         # 5 ps
variable        nfinal       equal 5000         # 5 ps

# ---------- 1. Initialization ----------
units           metal
dimension       3
boundary        p p f
atom_style      atomic

## thermo outputs are defined after the box is created

# ---------- 2. Create substrate (pure C) ----------
lattice         diamond ${a}
region          box block 0 ${nx} 0 ${ny} 0 ${nz} units lattice
create_box      2 box                       # type 1=C, type 2=N
create_atoms    1 box

mass            1 12.011
mass            2 14.007

thermo          500
thermo_style    custom step atoms temp pe ke etotal press
thermo_modify   lost ignore

region          thermostat_layer block INF INF INF INF 0 2 units lattice
variable        z_mobile_hi  equal ${nz}-2
region          newton_layer     block INF INF INF INF 2 ${z_mobile_hi} units lattice
group           thermostat_atoms region thermostat_layer
group           newton_atoms     region newton_layer
group           simulation_atoms union newton_atoms thermostat_atoms

# fix bottom layer to prevent drift and atom loss
velocity        thermostat_atoms set 0.0 0.0 0.0
fix             fFIX thermostat_atoms setforce 0.0 0.0 0.0

variable        zmax        equal ${nz}
variable        inj_lo      equal ${zmax}-0.5
variable        inj_hi      equal ${zmax}-0.1
region          inject      block INF INF INF INF ${inj_lo} ${inj_hi} units lattice

# ---------- 3. Potential ----------
pair_style      tersoff/zbl
pair_coeff      * * BNC_tersoff_zbl.potential C N
neighbor        2.0 bin
neigh_modify    delay 10 check yes

# ---------- 4. Initial relaxation @293K ----------
timestep        ${dt}
velocity        newton_atoms create 293.0 13579 mom yes rot yes
fix             fNVT newton_atoms nvt temp 293.0 293.0 0.1
fix             fLAN thermostat_atoms langevin 293.0 293.0 0.1 98765
run             ${nrelax1}
unfix           fNVT
unfix           fLAN

dump            dtraj all custom 1000 mini_traj.dump id type x y z
dump_modify     dtraj sort id

# ---------- 5. Ion implantation (few ions) ----------
## Redefine insertion region after initial relaxation using current box size
variable        xlo_cur     equal xlo
variable        xhi_cur     equal xhi
variable        ylo_cur     equal ylo
variable        yhi_cur     equal yhi
variable        zlo_cur     equal zlo
variable        zhi_cur     equal zhi
variable        inj_hi_box  equal ${zhi_cur}-5.0    # 5 A below current top
variable        inj_lo_box  equal ${zhi_cur}-10.0   # 10->5 A thick slab below top
# shrink x/y bounds slightly inside the box to avoid edge-equality issues
variable        eps         equal 0.01
variable        xlo_in      equal ${xlo_cur}+${eps}
variable        xhi_in      equal ${xhi_cur}-${eps}
variable        ylo_in      equal ${ylo_cur}+${eps}
variable        yhi_in      equal ${yhi_cur}-${eps}
region          inject_box  block ${xlo_in} ${xhi_in} ${ylo_in} ${yhi_in} ${inj_lo_box} ${inj_hi_box} units box side in

variable        energy_J     equal ${energy_eV}*1.60218e-19
variable        mass_kg      equal 14.007*1.66054e-27
variable        v_mps        equal sqrt(2*${energy_J}/${mass_kg})
variable        v_Aps        equal ${v_mps}/1.0e10

compute_modify  thermo_temp dynamic/dof yes
## Integrate during implantation: NVE on mobile atoms, Langevin on bottom
fix             fNVE    newton_atoms nve
fix             fLAN_imp thermostat_atoms langevin 293.0 293.0 0.1 224466

fix             implant all deposit ${n_ions} 2 100 ${seed} region inject_box near 1.0 attempt 20 vz -${v_Aps} -${v_Aps}
run             ${nimplant}
variable        ndeposit equal f_implant
print           "Deposited ions during implant: ${ndeposit}"
unfix           implant
unfix           fLAN_imp
unfix           fNVE

# post-implant short relax
fix             fNVT newton_atoms nvt temp 293.0 293.0 0.1
fix             fLAN thermostat_atoms langevin 293.0 293.0 0.1 98765
run             ${nrelax2}
unfix           fNVT
unfix           fLAN

# ---------- 6. Short anneal & cool ----------
fix             fNVT newton_atoms nvt temp 293.0 1600.0 0.5
fix             fLAN thermostat_atoms langevin 293.0 1600.0 0.5 13579
run             ${nramp}
unfix           fNVT
unfix           fLAN

fix             fNVT newton_atoms nvt temp 1600.0 1600.0 0.1
fix             fLAN thermostat_atoms langevin 1600.0 1600.0 0.1 24680
run             ${nanneal}
unfix           fNVT
unfix           fLAN

fix             fNVT newton_atoms nvt temp 1600.0 293.0 0.5
fix             fLAN thermostat_atoms langevin 1600.0 293.0 0.5 11223
run             ${ncool}
unfix           fNVT
unfix           fLAN

fix             fNVT newton_atoms nvt temp 293.0 293.0 0.1
fix             fLAN thermostat_atoms langevin 293.0 293.0 0.1 33445
run             ${nfinal}
unfix           fNVT
unfix           fLAN

print           "Mini simulation finished."

